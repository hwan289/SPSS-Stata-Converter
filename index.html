<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatConvert Studio (Powered by Puter.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        textarea, .code-editor { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            line-height: 1.7; /* èˆ’é€‚çš„è¡Œé«˜ */
            outline: none;
        }

        /* è¯­æ³•é«˜äº®æ ·å¼ - æŒ‰éœ€æ±‚è°ƒæ•´é¢œè‰² */
        .syntax-line { min-height: 1.5em; } 
        .syntax-comment { color: #4b5563; font-style: italic; font-weight: 500; } /* æ·±ç°è‰²æ³¨é‡Š */
        .syntax-keyword { color: #16a34a; font-weight: 700; }   /* ç»¿è‰²å¼ºè°ƒç»“æœ (Green 600) */
        .syntax-string { color: #0891b2; }                      /* é’è‰²å­—ç¬¦ä¸² */
        .syntax-num { color: #d97706; }                         /* æ©™è‰²æ•°å­— */
        
        /* æ‹–æ‹½ä¸Šä¼ è¦†ç›–å±‚ */
        #dropOverlay {
            backdrop-filter: blur(2px);
            transition: all 0.2s;
        }
        #dropOverlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Output Focus Ring */
        #outputDisplay:focus {
            background-color: #f0fdf4; /* èšç„¦æ—¶èƒŒæ™¯å¾®ç»¿ï¼Œå‘¼åº”ç»“æœ */
            outline: none;
        }

        /* Toast Animation */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .toast-enter { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="toastContainer" class="fixed bottom-12 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>

    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-4 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 text-white flex items-center justify-center rounded-lg font-bold font-mono text-sm shadow-md shadow-indigo-200">SC</div>
                <div>
                    <h1 class="font-bold text-base tracking-tight text-gray-900 leading-tight hidden md:block" data-i18n="appName">StatConvert Studio</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] text-gray-400 font-medium" data-i18n="poweredBy">Powered by Puter.js</span>
                    </div>
                </div>
            </div>
            
            <div class="hidden lg:flex items-center gap-2 ml-4 border-l border-gray-200 pl-4">
                <a href="https://docs.puter.com/" onclick="handleCopyLink(event, this.href)" class="text-[10px] px-2 py-1 bg-gray-50 border border-gray-200 rounded hover:bg-gray-100 hover:border-gray-300 text-gray-600 transition-all font-medium flex items-center gap-1.5 cursor-pointer group" title="Left Click: Copy Link | Right Click: Menu">
                    <svg class="w-3 h-3 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    Puter.js Docs
                </a>
                <a href="https://docs.puter.com/playground/" onclick="handleCopyLink(event, this.href)" class="text-[10px] px-2 py-1 bg-gray-50 border border-gray-200 rounded hover:bg-gray-100 hover:border-gray-300 text-gray-600 transition-all font-medium flex items-center gap-1.5 cursor-pointer group" title="Left Click: Copy Link | Right Click: Menu">
                    <svg class="w-3 h-3 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Puter.js Playground
                </a>
                
                <div class="w-px h-4 bg-gray-200 mx-1"></div>

                <a href="https://hwan289.github.io/Stata-Master/" target="_blank" class="text-[10px] px-2 py-1 bg-indigo-50 border border-indigo-100 rounded hover:bg-indigo-100 hover:border-indigo-200 text-indigo-700 transition-all font-bold flex items-center gap-1.5 cursor-pointer group">
                    <svg class="w-3 h-3 text-indigo-500 group-hover:text-indigo-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    <span id="stataMasterBtn">Stataå¤§å¸ˆ</span>
                </a>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div id="authSection" class="flex items-center gap-2 transition-all">
                <div id="authLoading" class="flex items-center gap-2 px-3 py-1 bg-gray-50 rounded-md border border-gray-100">
                    <div class="w-2 h-2 bg-gray-300 rounded-full animate-ping"></div>
                    <span class="text-[10px] text-gray-400">Auth...</span>
                </div>
                <button id="loginBtn" onclick="handleLogin()" class="hidden bg-gray-900 hover:bg-black text-white text-[10px] font-bold px-3 py-1.5 rounded-md transition-colors shadow-sm flex items-center gap-1.5 active:scale-95">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                    <span data-i18n="loginBtn">ç™»å½• Puter</span>
                </button>
                        
        <div id="userProfile" class="hidden flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-md pl-2 pr-1 py-0.5">
            <div class="flex items-center gap-1.5">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                <span id="usernameDisplay" class="text-[10px] font-bold text-gray-700 max-w-[80px] truncate">User</span>
            </div>
            
            <div class="w-px h-3 bg-gray-300 mx-1"></div>
            
            <a href="https://puter.com" 
               target="_blank"
               onclick="handleCopyLink(event, this.href)"
               class="text-[10px] font-medium text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer flex items-center gap-1 transition-colors"
               data-i18n="dashboardBtn"
               data-i18n-title="dashboardTip"
               title="Left Click: Copy Link | Right Click: Menu">
                Puter Credits
            </a>
        
            <button onclick="handleLogout()" class="ml-1 p-1 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded transition-colors" title="Sign Out">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            </button>
        </div>
            </div>
            <div class="h-5 w-px bg-gray-200 mx-1"></div>
            <button onclick="toggleModal('guideModal')" class="text-gray-500 hover:text-indigo-600 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-gray-50 text-xs font-medium group border border-transparent hover:border-gray-200">
                <svg class="w-4 h-4 text-gray-400 group-hover:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <span data-i18n="guideBtn">ä½¿ç”¨æŒ‡å—</span>
            </button>
            <div class="h-5 w-px bg-gray-200 mx-1"></div>
            <div class="relative bg-purple-50/80 hover:bg-purple-100 rounded-lg border border-purple-200/60 px-3 py-1.5 flex items-center justify-center transition-colors cursor-pointer group w-24">
                <select id="langSelector" onchange="changeLanguage(this.value)" class="bg-transparent text-xs font-bold text-purple-700 focus:outline-none cursor-pointer hover:text-purple-900 appearance-none pr-4 text-center w-full h-full absolute opacity-0 z-10 top-0 left-0">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="fr">FranÃ§ais</option>
                </select>
                <div class="flex items-center gap-1 pointer-events-none w-full justify-center">
                    <span id="currentLangLabel" class="text-xs font-bold text-purple-700 group-hover:text-purple-900">ä¸­æ–‡</span>
                    <svg class="w-3 h-3 text-purple-400 absolute right-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white/80 backdrop-blur-md border-b border-gray-200 py-2 px-4 flex flex-col md:flex-row items-center justify-between gap-4 shrink-0 z-20 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)]">
        
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative bg-gray-100 p-1 rounded-lg flex items-center w-full md:w-auto border border-gray-200 shadow-inner max-w-[300px]">
                <div id="toggleHighlight" class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-md shadow-sm transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] border border-gray-100"></div>
                <button onclick="setDirection('spss2stata')" class="relative z-10 w-1/2 md:w-32 py-1 text-xs font-bold text-center transition-colors duration-300" id="btnSpssToStata">SPSS &rarr; Stata</button>
                <button onclick="setDirection('stata2spss')" class="relative z-10 w-1/2 md:w-32 py-1 text-xs font-bold text-center transition-colors duration-300 text-gray-500" id="btnStataToSpss">Stata &rarr; SPSS</button>
                <input type="hidden" id="directionValue" value="spss2stata">
            </div>

            <div class="hidden md:flex items-center gap-1 border-l border-gray-200 pl-4">
                <span id="fontSizeDisplay" class="text-[10px] font-mono font-bold text-gray-600 w-10 text-center mr-1">14px</span>
                <button onclick="adjustFontSize(-1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-indigo-600 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 transition-all active:scale-95" title="Decrease Size">-</button>
                <button onclick="adjustFontSize(1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-indigo-600 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 transition-all active:scale-95" title="Increase Size">+</button>
            </div>
        </div>

        <div class="flex items-center gap-2 w-full md:w-auto justify-center md:justify-end">
            <button onclick="runConversion(false)" id="convertBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-5 py-1.5 text-xs font-bold tracking-wide transition-all flex items-center gap-2 shadow-md shadow-indigo-200 hover:shadow-lg hover:shadow-indigo-200 active:scale-95 active:translate-y-0.5">
                <span data-i18n="runBtn">è¿è¡Œè½¬æ¢</span>
                <svg id="playIcon" class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button onclick="stopConversion()" id="stopBtn" class="hidden bg-red-500 hover:bg-red-600 text-white rounded-lg px-5 py-1.5 text-xs font-bold tracking-wide transition-all flex items-center gap-2 shadow-md shadow-red-200 hover:shadow-lg hover:shadow-red-200 active:scale-95 active:translate-y-0.5 animate-pulse">
                <span data-i18n="stopBtn">åœæ­¢è¿è¡Œ</span>
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
            </button>
            <div class="relative group">
                <select id="providerModel" class="appearance-none bg-white border border-gray-300 text-gray-700 py-1.5 pl-3 pr-8 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 cursor-pointer w-full md:w-56 shadow-sm transition-all hover:border-indigo-300">
                    </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 group-hover:text-indigo-500 transition-colors">
                    <svg class="h-3 w-3 fill-current" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
            <button onclick="toggleModal('modelHelpModal')" class="text-gray-400 hover:text-indigo-600 transition-colors p-1.5 hover:bg-gray-100 rounded-md" title="Model Help">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
        </div>
    </div>

    <main class="flex-grow flex flex-col md:flex-row overflow-hidden relative bg-gray-50">
        <div class="flex-1 flex flex-col border-r border-gray-200 bg-white relative group" id="sourceContainer">
            <div id="dropOverlay" class="absolute inset-0 bg-indigo-50/90 z-20 flex flex-col items-center justify-center opacity-0 pointer-events-none border-2 border-indigo-400 border-dashed m-2 rounded-xl">
                <svg class="w-12 h-12 text-indigo-500 mb-2 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <span class="text-sm font-bold text-indigo-700" data-i18n="dropMsg">é‡Šæ”¾æ–‡ä»¶ä»¥åŠ è½½</span>
            </div>
            <div class="h-10 flex items-center justify-between px-4 border-b border-gray-100 bg-white shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-300"></span>
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wide transition-all" id="sourceLabel">SPSS SOURCE</span>
                </div>
                <div class="flex items-center gap-3">
                    <input type="file" id="fileInput" class="hidden" accept=".sps,.do,.txt,.ado">
                    <button onclick="document.getElementById('fileInput').click()" class="text-[10px] font-medium text-gray-400 hover:text-indigo-600 transition-colors uppercase tracking-wider flex items-center gap-1" data-i18n="uploadBtn">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg> UPLOAD
                    </button>
                    <button onclick="clearAll()" class="text-[10px] font-medium text-gray-400 hover:text-red-500 transition-colors uppercase tracking-wider flex items-center gap-1" data-i18n="clearBtn">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> CLEAR
                    </button>
                </div>
            </div>
            <textarea id="sourceCode" class="flex-grow p-4 font-mono text-sm bg-white custom-scroll resize-none focus:outline-none text-gray-700 placeholder-gray-300" spellcheck="false" placeholder="// ..."></textarea>
        </div>

        <div class="flex-1 flex flex-col bg-gray-50">
            <div class="h-10 flex items-center justify-between px-4 border-b border-gray-200 bg-gray-50 shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-indigo-500 shadow-sm shadow-indigo-200"></span>
                    <span class="text-xs font-bold text-indigo-600 uppercase tracking-wide transition-all" id="targetLabel">STATA OUTPUT</span>
                </div>
                <button onclick="copyOutput()" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-700 transition-colors uppercase tracking-wider flex items-center gap-1 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded border border-indigo-100" data-i18n="copyBtn">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> COPY
                </button>
            </div>
            
            <div class="relative flex-grow flex flex-col overflow-hidden">
                <div id="outputDisplay" tabindex="0" class="flex-grow p-4 font-mono text-sm bg-transparent custom-scroll focus:outline-none text-gray-800 overflow-y-auto" contenteditable="false"></div>
                <textarea id="outputCode" class="hidden"></textarea>
                <div id="outputPlaceholder" class="absolute top-4 left-4 text-gray-300 font-mono text-sm pointer-events-none select-none">// AI Output will appear here...</div>
                <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-[2px] flex flex-col items-center justify-center z-20 transition-opacity duration-200">
                    <div class="bg-white p-5 rounded-2xl shadow-xl border border-gray-100 flex flex-col items-center gap-3 min-w-[180px] animate-in fade-in zoom-in duration-200">
                        <div class="flex items-center gap-2">
                            <svg class="animate-spin w-5 h-5 text-indigo-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span class="text-xs font-bold text-gray-700" data-i18n="convertingMsg">AI Processing</span>
                        </div>
                        <span id="timerDisplay" class="text-lg font-mono text-indigo-600 font-bold tabular-nums">0.0s</span>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-white shrink-0 z-10">
                <div class="px-4 py-1.5 bg-gray-50 border-b border-gray-100 flex items-center gap-2 cursor-pointer hover:bg-gray-100 transition-colors group" onclick="toggleErrorPanel()">
                    <div class="p-0.5 bg-orange-100 rounded text-orange-600 group-hover:bg-orange-200 transition-colors">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </div>
                    <span class="text-[11px] font-bold text-gray-600 group-hover:text-gray-800" data-i18n="fixLabel">æ™ºèƒ½ä¿®å¤ (Auto-Fix)</span>
                    <svg id="chevronIcon" class="w-3 h-3 text-gray-400 transform rotate-180 transition-transform ml-auto group-hover:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                </div>
                <div id="errorPanel" class="hidden flex-col gap-2 p-3 bg-white transition-all">
                    <textarea id="errorMessage" class="w-full h-20 p-2 text-xs bg-gray-50 border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-500 font-mono resize-none placeholder-gray-400" placeholder="..."></textarea>
                    <div class="flex justify-between items-center">
                        <span id="fixTimerDisplay" class="text-xs font-mono text-orange-600 font-bold tabular-nums hidden">0.0s</span>
                        <button onclick="runConversion(true)" id="fixBtn" disabled class="ml-auto bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 transition-all">
                            <span data-i18n="fixBtn">ä¿®å¤ä»£ç </span>
                            <svg id="fixSpinner" class="hidden animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-50 border-t border-gray-200 py-1.5 px-4 text-center shrink-0">
        <p class="text-[9px] text-gray-400 font-medium" data-i18n="footerText">Last Edited: 2025-11-21</p>
    </footer>

    <div id="modelHelpModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300" onclick="if(event.target===this) toggleModal('modelHelpModal')"><div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-transform duration-300"><div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3"><h3 class="text-lg font-bold text-gray-900" data-i18n="helpTitle">Model Guide</h3><button onclick="toggleModal('modelHelpModal')" class="text-gray-400 hover:text-black"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div id="helpContent" class="space-y-4 text-xs md:text-sm text-gray-600 leading-relaxed"></div></div></div>
    <div id="guideModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300" onclick="if(event.target===this) toggleModal('guideModal')"><div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 transform scale-95 transition-transform duration-300 overflow-y-auto max-h-[80vh]"><div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3"><h3 class="text-lg font-bold text-gray-900" data-i18n="guideBtn">ä½¿ç”¨æŒ‡å—</h3><button onclick="toggleModal('guideModal')" class="text-gray-400 hover:text-black"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div id="guideContent" class="space-y-4 text-sm text-gray-600 leading-relaxed"></div></div></div>

    <script>
        if (window.location.protocol === 'file:') {
            alert("ğŸ›‘ é”™è¯¯ / ERROR:\n\nPuter.js æ— æ³•åœ¨æœ¬åœ°æ–‡ä»¶ (file://) æ¨¡å¼ä¸‹ä½¿ç”¨ç™»å½•åŠŸèƒ½ã€‚\nPlease use VS Code Live Server or host it online.");
        }

        const i18n = {
            zh: { 
                appName: "StatConvert Studio", poweredBy: "Powered by Puter.js", sourceLabel: "æºä»£ç ", targetLabel: "è¾“å‡ºç»“æœ", uploadBtn: "ä¸Šä¼ ", clearBtn: "æ¸…ç©º", copyBtn: "å¤åˆ¶ç»“æœ", runBtn: "è¿è¡Œè½¬æ¢", stopBtn: "åœæ­¢è¿è¡Œ", fixLabel: "æ™ºèƒ½ä¿®å¤ (Auto-Fix)", fixBtn: "ä¿®å¤ä»£ç ", convertingMsg: "AI å¤„ç†ä¸­", helpTitle: "æ¨¡å‹é€‰æ‹©æŒ‡å—", guideBtn: "ä½¿ç”¨æŒ‡å—", dropMsg: "é‡Šæ”¾æ–‡ä»¶ä»¥åŠ è½½", loginBtn: "ç™»å½• Puter",
                linkCopied: "é“¾æ¥å·²å¤åˆ¶ï¼", footerText: "æœ€åæ›´æ–°: 2025-11-21", stataMaster: "Stataå¤§å¸ˆ",
                exitMsg: "æ‚¨ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¼šä¸¢å¤±ã€‚", overwriteMsg: "æ£€æµ‹åˆ°å·²æœ‰å†…å®¹ã€‚æ˜¯å¦è¦†ç›–å½“å‰ä»£ç ï¼Ÿ", stoppedMsg: "å·²åœæ­¢è¿è¡Œ", loginRequired: "è¯·å…ˆç™»å½• Puter è´¦å·ä»¥ä½¿ç”¨ AI åŠŸèƒ½",
                clearMsg: "ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ",
                dashboardBtn: "Puter é¢åº¦", dashboardTip: "ç‚¹å‡»æŸ¥çœ‹ AI ä½¿ç”¨é‡ï¼Œä»¥å†³å®šæ˜¯å¦ä½¿ç”¨å…è´¹æ¨¡å‹",
                errorPlaceholder: "ç²˜è´´æŠ¥é”™ä¿¡æ¯ (ä¾‹å¦‚: 'command tabulate not found')...", sourcePlaceholder: "// è¯·åœ¨æ­¤ç²˜è´´ä»£ç ... (æ”¯æŒæ‹–æ‹½ä¸Šä¼  / Ctrl + Enter è¿è¡Œ)", outputPlaceholder: "// AI è½¬æ¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...",
                modelGuide: `<div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3"><h4 class="font-bold text-indigo-900 mb-1 text-xs uppercase tracking-wide">âš¡ æ¨èé¦–é€‰</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Flash</strong>: æœ€å¹³è¡¡çš„é€‰æ‹©ã€‚é€Ÿåº¦å¿«ï¼Œç†è§£åŠ›å¥½ã€‚</li></ul></div><div class="bg-purple-50 p-3 rounded-lg border border-purple-100 mb-3"><h4 class="font-bold text-purple-900 mb-1 text-xs uppercase tracking-wide">ğŸ§  å¤æ‚é€»è¾‘</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Pro</strong>: é€‚åˆå¤„ç†å¤æ‚çš„å® (Macro) å’Œå¾ªç¯ã€‚</li><li><strong>GPT-5.1</strong>: æ——èˆ°æ¨¡å‹ï¼Œè§£å†³ç–‘éš¾æ‚ç—‡ã€‚</li></ul></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><h4 class="font-bold text-gray-900 mb-1 text-xs uppercase tracking-wide">ğŸŒŒ å‰æ²¿æ¢ç´¢</h4><ul class="list-disc list-inside mt-1"><li><strong>GPT-5 Latest Chat</strong>: é€Ÿåº¦å¿«ã€‚</li></ul></div>`,
                guideContent: `<p><strong>å¦‚ä½•ä½¿ç”¨æœ¬å·¥å…·ï¼š</strong></p><ol class="list-decimal list-inside space-y-2 mt-2"><li><strong>ç™»å½•ï¼š</strong>ä½¿ç”¨ Puter.js è´¦å·ç™»å½•ï¼ˆå³ä¸Šè§’æŒ‰é’®ï¼‰ã€‚</li><li><strong>ä¸Šä¼ ä»£ç ï¼š</strong>ç›´æ¥ç²˜è´´ SPSS/Stata ä»£ç åˆ°å·¦ä¾§è¾“å…¥æ¡†ï¼Œæˆ–å°† .sps/.do æ–‡ä»¶æ‹–æ‹½åˆ°å·¦ä¾§åŒºåŸŸã€‚</li><li><strong>é€‰æ‹©æ¨¡å‹ï¼š</strong>åœ¨é¡¶éƒ¨é€‰æ‹© AI æ¨¡å‹ï¼ˆæ¨è Gemini 2.5 Flashï¼‰ã€‚</li><li><strong>è¿è¡Œè½¬æ¢ï¼š</strong>ç‚¹å‡»â€œè¿è¡Œè½¬æ¢â€æŒ‰é’®ï¼Œå³ä¾§å°†æ˜¾ç¤ºè½¬æ¢åçš„ä»£ç ï¼ˆå‘½ä»¤ä¸ºè“è‰²ï¼Œæ³¨é‡Šä¸ºç°è‰²ï¼‰ã€‚</li><li><strong>åœæ­¢è¿è¡Œï¼š</strong>å¦‚æœæ¨¡å‹å“åº”æ—¶é—´è¿‡é•¿ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œåœæ­¢è¿è¡Œâ€å¹¶åˆ‡æ¢æ¨¡å‹ã€‚</li><li><strong>æ™ºèƒ½ä¿®å¤ï¼š</strong>å¦‚æœè½¬æ¢åçš„ä»£ç æŠ¥é”™ï¼Œè¯·ç‚¹å‡»å³ä¾§åº•éƒ¨çš„â€œæ™ºèƒ½ä¿®å¤â€ï¼Œç²˜è´´æŠ¥é”™ä¿¡æ¯å¹¶ç‚¹å‡»â€œä¿®å¤ä»£ç â€ã€‚</li><li><strong>å¤åˆ¶ç»“æœï¼š</strong>ç‚¹å‡»å³ä¾§é¡¶éƒ¨çš„â€œå¤åˆ¶ç»“æœâ€æŒ‰é’®å³å¯ã€‚</li></ol>`,
                optGroups: ["Google Gemini (æ–°ä¸€ä»£)", "OpenAI (GPT-5 ç³»åˆ—)", "xAI (Grok)"],
                modelDesc: { rec: "(æ¨è)", fast: "", reason: "(å¼ºæ¨ç†)", prev: "(é¢„è§ˆ)", flag: "(æ——èˆ°)" }
            },
            en: { 
                appName: "StatConvert Studio", poweredBy: "Powered by Puter.js", sourceLabel: "Source Code", targetLabel: "Output", uploadBtn: "Upload", clearBtn: "Clear", copyBtn: "Copy Result", runBtn: "Run Convert", stopBtn: "Stop Running", fixLabel: "Auto-Fix Code", fixBtn: "Fix Code", convertingMsg: "AI Processing", helpTitle: "Model Guide", guideBtn: "User Guide", dropMsg: "Drop file to load", loginBtn: "Sign in Puter",
                linkCopied: "Link Copied!", footerText: "Last Edited: 2025-11-21", stataMaster: "Stata Master",
                exitMsg: "Are you sure you want to leave? Unsaved changes will be lost.", overwriteMsg: "Content detected. Overwrite with new file?", stoppedMsg: "Process Stopped", loginRequired: "Please sign in to Puter to use AI features",
                clearMsg: "Are you sure you want to clear all content?",
                dashboardBtn: "Puter Credits", dashboardTip: "Click to check AI usage and decide if you need free models",
                errorPlaceholder: "Paste error message (e.g., 'command tabulate not found')...", sourcePlaceholder: "// Paste code here... (Drag & Drop supported / Ctrl + Enter to run)", outputPlaceholder: "// AI Output will appear here...",
                modelGuide: `<div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3"><h4 class="font-bold text-indigo-900 mb-1 text-xs uppercase tracking-wide">âš¡ Recommended</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Flash</strong>: Best balance of speed & quality.</li></ul></div><div class="bg-purple-50 p-3 rounded-lg border border-purple-100 mb-3"><h4 class="font-bold text-purple-900 mb-1 text-xs uppercase tracking-wide">ğŸ§  Complex Logic</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Pro</strong>: For macros and nested loops.</li><li><strong>GPT-5.1</strong>: Flagship model for hard tasks.</li></ul></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><h4 class="font-bold text-gray-900 mb-1 text-xs uppercase tracking-wide">ğŸŒŒ Bleeding Edge</h4><ul class="list-disc list-inside mt-1"><li><strong>GPT-5 Latest Chat</strong>: Fast.</li></ul></div>`,
                guideContent: `<p><strong>How to use:</strong></p><ol class="list-decimal list-inside space-y-2 mt-2"><li><strong>Sign In:</strong> Log in with Puter.js account (Top Right).</li><li><strong>Upload Code:</strong> Paste SPSS/Stata code on the left, or Drag & Drop .sps/.do files.</li><li><strong>Select Model:</strong> Choose an AI model (Gemini 2.5 Flash is recommended).</li><li><strong>Run:</strong> Click "Run Convert". The output will appear on the right with syntax highlighting.</li><li><strong>Stop:</strong> If it takes too long, you can click "Stop Running" to cancel and retry.</li><li><strong>Auto-Fix:</strong> If the code fails, open "Auto-Fix" at the bottom right, paste the error, and click "Fix Code".</li><li><strong>Copy:</strong> Click "Copy Result" to use the code.</li></ol>`,
                optGroups: ["Google Gemini (Next Gen)", "OpenAI (GPT-5 Series)", "xAI (Grok)"],
                modelDesc: { rec: "(Recommended)", fast: "", reason: "(Reasoning)", prev: "(Preview)", flag: "(Flagship)" }
            },
            fr: { 
                appName: "StatConvert Studio", poweredBy: "PropulsÃ© par Puter.js", sourceLabel: "Code Source", targetLabel: "RÃ©sultat", uploadBtn: "TÃ©lÃ©charger", clearBtn: "Effacer", copyBtn: "Copier", runBtn: "Convertir", stopBtn: "ArrÃªter", fixLabel: "Correction Auto", fixBtn: "Corriger", convertingMsg: "Traitement", helpTitle: "Guide des ModÃ¨les", guideBtn: "Guide d'Utilisation", dropMsg: "DÃ©posez le fichier", loginBtn: "Connexion Puter",
                linkCopied: "Lien copiÃ© !", footerText: "DerniÃ¨re modification : 2025-11-21", stataMaster: "MaÃ®tre Stata",
                exitMsg: "Voulez-vous vraiment partir ? Les modifications non enregistrÃ©es seront perdues.", overwriteMsg: "Contenu dÃ©tectÃ©. Remplacer par le nouveau fichier ?", stoppedMsg: "Processus arrÃªtÃ©", loginRequired: "Veuillez vous connecter Ã  Puter pour utiliser l'IA",
                clearMsg: "Voulez-vous vraiment tout effacer ?",
                dashboardBtn: "CrÃ©dits Puter", dashboardTip: "Cliquez pour vÃ©rifier l'utilisation de l'IA et dÃ©cider d'utiliser des modÃ¨les gratuits",
                errorPlaceholder: "Coller l'erreur (ex: 'command tabulate not found')...", sourcePlaceholder: "// Collez votre code... (Glisser-dÃ©poser supportÃ© / Ctrl + EntrÃ©e)", outputPlaceholder: "// RÃ©sultat...",
                modelGuide: `<div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3"><h4 class="font-bold text-indigo-900 mb-1 text-xs uppercase tracking-wide">âš¡ RecommandÃ©</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Flash</strong>: Ã‰quilibre vitesse/qualitÃ©.</li></ul></div><div class="bg-purple-50 p-3 rounded-lg border border-purple-100 mb-3"><h4 class="font-bold text-purple-900 mb-1 text-xs uppercase tracking-wide">ğŸ§  Logique Complexe</h4><ul class="list-disc list-inside mt-1"><li><strong>Gemini 2.5 Pro</strong>: Pour les macros.</li><li><strong>GPT-5.1</strong>: ModÃ¨le phare.</li></ul></div><div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><h4 class="font-bold text-gray-900 mb-1 text-xs uppercase tracking-wide">ğŸŒŒ Avant-premiÃ¨re</h4><ul class="list-disc list-inside mt-1"><li><strong>GPT-5 Latest Chat</strong>: Rapide.</li></ul></div>`,
                guideContent: `<p><strong>Comment utiliser :</strong></p><ol class="list-decimal list-inside space-y-2 mt-2"><li><strong>Connexion :</strong> Connectez-vous avec Puter.js (Haut Droite).</li><li><strong>TÃ©lÃ©charger :</strong> Collez le code SPSS/Stata Ã  gauche ou glissez-dÃ©posez des fichiers .sps/.do.</li><li><strong>ModÃ¨le :</strong> Choisissez un modÃ¨le IA (Gemini 2.5 Flash recommandÃ©).</li><li><strong>Convertir :</strong> Cliquez sur "Convertir". Le rÃ©sultat s'affiche Ã  droite avec coloration syntaxique.</li><li><strong>ArrÃªter :</strong> Si c'est trop long, cliquez sur "ArrÃªter" pour annuler.</li><li><strong>Correction :</strong> Si le code Ã©choue, ouvrez "Correction Auto" en bas Ã  droite, collez l'erreur et cliquez sur "Corriger".</li><li><strong>Copier :</strong> Cliquez sur "Copier" pour utiliser le code.</li></ol>`,
                optGroups: ["Google Gemini (Nouvelle Gen)", "OpenAI (SÃ©rie GPT-5)", "xAI (Grok)"],
                modelDesc: { rec: "(RecommandÃ©)", fast: "", reason: "(Raisonnement)", prev: "(AperÃ§u)", flag: "(Phare)" }
            }
        };
        let currentLang = 'en';
        let currentFontSize = 14;
        let currentRunId = 0;

        async function initAuth() {
            const loadEl = document.getElementById('authLoading');
            const loginBtn = document.getElementById('loginBtn');
            const profile = document.getElementById('userProfile');
            const userDisplay = document.getElementById('usernameDisplay');

            try {
                if (puter.auth.isSignedIn()) {
                    const user = await puter.auth.getUser();
                    loadEl.classList.add('hidden');
                    loginBtn.classList.add('hidden');
                    profile.classList.remove('hidden', 'flex');
                    profile.classList.add('flex');
                    userDisplay.innerText = user.username || "User";
                } else {
                    loadEl.classList.add('hidden');
                    loginBtn.classList.remove('hidden');
                    profile.classList.add('hidden');
                }
            } catch (err) {
                console.error("Auth Check Failed:", err);
                loadEl.classList.add('hidden');
                loginBtn.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            try { await puter.auth.signIn(); initAuth(); } catch (e) { alert("Login failed: " + e.message); }
        }

        async function handleLogout() {
            try { await puter.auth.signOut(); initAuth(); showToast("Signed out"); } catch (e) { console.error(e); }
        }

        // Puter Link Handler (Left Click Only)
        function handleCopyLink(e, url) {
            if (e.button === 0) { // 0 = Left click
                e.preventDefault(); // Stop navigation
                navigator.clipboard.writeText(url);
                showToast(i18n[currentLang].linkCopied);
            }
            // Right click allows default menu (Open in new tab)
        }

        // Output Display Focus Logic for Select All
        const outputDisplay = document.getElementById('outputDisplay');
        outputDisplay.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                const range = document.createRange();
                range.selectNodeContents(outputDisplay);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        });

        // --- Standard Logic ---
        const sourceContainer = document.getElementById('sourceContainer');
        const dropOverlay = document.getElementById('dropOverlay');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            sourceContainer.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            sourceContainer.addEventListener(eventName, () => dropOverlay.classList.add('active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            sourceContainer.addEventListener(eventName, () => dropOverlay.classList.remove('active'), false);
        });
        sourceContainer.addEventListener('drop', handleDrop, false);
        function handleDrop(e) { handleFiles(e.dataTransfer.files); }

        window.onbeforeunload = function(e) {
            const msg = i18n[currentLang].exitMsg;
            e = e || window.event;
            if (e) { e.returnValue = msg; }
            return msg;
        };

        function showToast(msg) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-enter bg-gray-800 text-white text-xs px-4 py-2 rounded-full shadow-lg mb-2 backdrop-blur-md bg-opacity-90';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, 20px)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function adjustFontSize(delta) {
            currentFontSize += delta;
            if (currentFontSize < 10) currentFontSize = 10;
            if (currentFontSize > 24) currentFontSize = 24;
            
            document.getElementById('fontSizeDisplay').innerText = currentFontSize + 'px';
            document.getElementById('sourceCode').style.fontSize = currentFontSize + 'px';
            document.getElementById('outputDisplay').style.fontSize = currentFontSize + 'px';
        }

        function setDirection(dir) {
            document.getElementById('directionValue').value = dir;
            const hl = document.getElementById('toggleHighlight');
            const b1 = document.getElementById('btnSpssToStata');
            const b2 = document.getElementById('btnStataToSpss');
            if (dir === 'spss2stata') {
                hl.style.transform = 'translateX(0)';
                b1.classList.replace('text-gray-500', 'text-indigo-700');
                b2.classList.replace('text-indigo-700', 'text-gray-500');
            } else {
                hl.style.transform = 'translateX(100%)';
                b1.classList.replace('text-indigo-700', 'text-gray-500');
                b2.classList.replace('text-gray-500', 'text-indigo-700');
            }
            updateLabelText();
        }

        function updateLabelText() {
            const dir = document.getElementById('directionValue').value;
            const t = i18n[currentLang];
            const spss = "SPSS"; const stata = "Stata";
            const sLbl = t.sourceLabel.replace('SPSS','').replace('Stata','').trim();
            const tLbl = t.targetLabel.replace('SPSS','').replace('Stata','').trim();
            if (dir === 'spss2stata') {
                document.getElementById('sourceLabel').textContent = `${spss} ${sLbl}`;
                document.getElementById('targetLabel').textContent = `${stata} ${tLbl}`;
            } else {
                document.getElementById('sourceLabel').textContent = `${stata} ${sLbl}`;
                document.getElementById('targetLabel').textContent = `${spss} ${tLbl}`;
            }
        }

        function changeLanguage(lang) {
            currentLang = lang;
            const t = i18n[lang];
            // Update innerHTML text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                if(t[el.dataset.i18n]) el.innerHTML = t[el.dataset.i18n];
            });
            // Update title attributes (tooltips)
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                if(t[el.dataset.i18nTitle]) el.title = t[el.dataset.i18nTitle];
            });

            document.getElementById('errorMessage').placeholder = t.errorPlaceholder;
            document.getElementById('sourceCode').placeholder = t.sourcePlaceholder;
            document.getElementById('outputPlaceholder').innerText = t.outputPlaceholder;
            document.getElementById('helpContent').innerHTML = t.modelGuide;
            document.getElementById('guideContent').innerHTML = t.guideContent;
            document.getElementById('stataMasterBtn').innerText = t.stataMaster;
            const langLabels = {zh: "ä¸­æ–‡", en: "English", fr: "FranÃ§ais"};
            document.getElementById('currentLangLabel').innerText = langLabels[lang];
            renderModelOptions();
            updateLabelText();
        }

        function renderModelOptions() {
            const t = i18n[currentLang];
            const sel = document.getElementById('providerModel');
            const currentVal = sel.value || 'gemini-2.5-flash';
            sel.innerHTML = `
                <optgroup label="${t.optGroups[0]}">
                    <option value="gemini-2.5-flash">âš¡ Gemini 2.5 Flash ${t.modelDesc.rec}</option>
                    <option value="gemini-2.5-pro">ğŸ§  Gemini 2.5 Pro ${t.modelDesc.reason}</option>
                    <option value="gemini-3-pro-preview">ğŸš€ Gemini 3 Pro ${t.modelDesc.prev}</option>
                </optgroup>
                <optgroup label="${t.optGroups[1]}">
                    <option value="gpt-5.1">ğŸ¤– GPT-5.1 ${t.modelDesc.flag}</option>
                    <option value="gpt-5-nano">ğŸƒ GPT-5 Nano ${t.modelDesc.fast}</option>
                    <option value="gpt-5-chat-latest">ğŸ†• GPT-5 Latest Chat</option>
                </optgroup>
                <optgroup label="${t.optGroups[2]}">
                    <option value="x-ai/grok-4.1-fast">ğŸŒŒ Grok 4.1 Fast</option>
                </optgroup>
            `;
            sel.value = currentVal;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function highlightCode(code) {
            if (!code) return '';
            const lines = code.split('\n');
            let html = '';
            const keywords = new Set([
                'gen', 'generate', 'egen', 'replace', 'rename', 'drop', 'keep', 'sort', 'gsort',
                'sum', 'summarize', 'tab', 'tabulate', 'reg', 'regress', 'logit', 'probit', 'merge',
                'append', 'use', 'save', 'clear', 'set', 'display', 'list', 'describe', 'codebook',
                'GET', 'FILE', 'DATASET', 'ACTIVATE', 'FREQUENCIES', 'DESCRIPTIVES', 'CROSSTABS',
                'MEANS', 'CORRELATIONS', 'REGRESSION', 'COMPUTE', 'RECODE', 'IF', 'DO', 'IF', 'END',
                'EXECUTE', 'VARIABLE', 'LABELS', 'VALUE', 'MISSING', 'VALUES'
            ]);
            lines.forEach(line => {
                const trimmed = line.trim();
                let lineHtml = '';
                
                if (trimmed.startsWith('*') || trimmed.startsWith('//') || trimmed.startsWith('/*')) {
                    lineHtml = `<span class="syntax-comment">${escapeHtml(line)}</span>`;
                } else {
                    const tokens = line.split(/(\s+|"|'|\(|\)|,)/);
                    let inString = false;
                    for (let token of tokens) {
                        if (token === '"') {
                            inString = !inString;
                            lineHtml += `<span class="syntax-string">"</span>`;
                        } else if (inString) {
                            lineHtml += `<span class="syntax-string">${escapeHtml(token)}</span>`;
                        } else {
                            const cleanToken = token.trim();
                            const word = cleanToken.replace(/[^a-zA-Z0-9_]/g, '');
                            if (keywords.has(word) || keywords.has(word.toUpperCase())) {
                               lineHtml += token.replace(word, `<span class="syntax-keyword">${word}</span>`);
                            } else if (!isNaN(parseFloat(word)) && isFinite(word)) {
                                lineHtml += token.replace(word, `<span class="syntax-num">${word}</span>`);
                            } else {
                               lineHtml += escapeHtml(token);
                            }
                        }
                    }
                }
                // ä½¿ç”¨ div åŒ…è£¹æ¯ä¸€è¡Œï¼Œç¡®ä¿æ¢è¡Œ
                html += `<div class="syntax-line">${lineHtml || '&nbsp;'}</div>`; 
            });
            return html;
        }

        function extractTextFromResponse(resp) {
            let raw = "";
            if (!resp) return "";
            if (typeof resp === 'string') raw = resp;
            else if (resp.message && Array.isArray(resp.message.content)) raw = resp.message.content.map(p => p.text || "").join('\n\n');
            else if (typeof resp?.message?.content === 'string') raw = resp.message.content;
            else if (typeof resp?.text === 'string') raw = resp.text;
            else if (typeof resp?.content === 'string') raw = resp.content;
            else if (Array.isArray(resp?.choices) && resp.choices.length > 0) return extractTextFromResponse(resp.choices[0]);
            else raw = JSON.stringify(resp, null, 2);
            return raw.replace(/^```[a-zA-Z0-9]*\s*$/gm, '').replace(/^```\s*$/gm, '').replace(/\\n/g, '\n').trim();
        }

        let tInt = null; 
        function startTimer(isFix) {
            if(tInt) clearInterval(tInt);
            const d = isFix ? document.getElementById('fixTimerDisplay') : document.getElementById('timerDisplay');
            if(isFix) document.getElementById('fixTimerDisplay').classList.remove('hidden');
            const s = Date.now();
            d.innerText = "0.0s";
            tInt = setInterval(() => { d.innerText = ((Date.now()-s)/1000).toFixed(1)+"s"; }, 100);
        }
        function stopTimer() { if(tInt) clearInterval(tInt); tInt = null; }
        
        function stopConversion() {
            currentRunId++; 
            stopTimer();
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('fixSpinner').classList.add('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('convertBtn').classList.remove('hidden');
            showToast(i18n[currentLang].stoppedMsg);
        }

        async function runConversion(fix) {
            if(!puter.auth.isSignedIn()) {
                alert(i18n[currentLang].loginRequired);
                handleLogin();
                return;
            }

            const c = document.getElementById('sourceCode').value;
            const outDiv = document.getElementById('outputDisplay');
            const outTxt = document.getElementById('outputCode');
            const ph = document.getElementById('outputPlaceholder');
            const load = document.getElementById('loadingOverlay');
            const dir = document.getElementById('directionValue').value;
            const model = document.getElementById('providerModel').value;
            const spin = document.getElementById('fixSpinner');
            
            if(!c.trim()) return alert(i18n[currentLang].sourcePlaceholder);
            
            currentRunId++;
            const myRunId = currentRunId;

            startTimer(fix);
            if(fix) {
                spin.classList.remove('hidden'); 
            } else {
                load.classList.remove('hidden');
                document.getElementById('convertBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
            }

            try {
                const sl = dir==='spss2stata'?"SPSS":"Stata"; 
                const tl = dir==='spss2stata'?"Stata":"SPSS";
                const langName = currentLang === 'zh' ? "Simplified Chinese" : (currentLang === 'fr' ? "French" : "English");
                
                let p = "";
                if(fix){
                    const err = document.getElementById('errorMessage').value;
                    p = `IMPORTANT: Provide all explanations in ${langName}.
INSTRUCTION: Convert ${sl} code to ${tl} and fix errors.
OUTPUT RULES:
1. Suggest ALTERNATIVE commands.
2. Insert a blank line between distinct commands.
3. Use * or // for comments explaining WHY.
4. NO markdown code fences. Raw code only.
ORIGINAL CODE:
${c}
ERROR:
${err}`;
                } else {
                    p = `IMPORTANT: Provide all explanations in ${langName}.
INSTRUCTION: Convert ${sl} code to ${tl}.
OUTPUT RULES:
1. Output valid code.
2. Insert a blank line between distinct commands.
3. Use * or // for comments.
4. NO markdown code fences. Raw code only.
CODE:
${c}`;
                }

                const r = await puter.ai.chat(p, { model: model });
                
                if (myRunId !== currentRunId) { return; }

                const rawText = extractTextFromResponse(r);
                outTxt.value = rawText;
                ph.style.display = 'none';
                outDiv.innerHTML = highlightCode(rawText);
                updateFixButtonState();
                if(fix) {
                    showToast(currentLang==='zh'?"ä¿®å¤å®Œæˆï¼":(currentLang==='fr'?"CorrigÃ©!":"Fixed!"));
                    document.getElementById('errorMessage').value='';
                    updateFixButtonState();
                }
            } catch(e) {
                if (myRunId !== currentRunId) return;
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                if (myRunId === currentRunId) {
                    stopTimer();
                    load.classList.add('hidden');
                    spin.classList.add('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('convertBtn').classList.remove('hidden');
                }
            }
        }

        function updateFixButtonState(){const e=document.getElementById('errorMessage').value.trim();const o=document.getElementById('outputCode').value.trim();document.getElementById('fixBtn').disabled=!(e&&o);}
        document.getElementById('errorMessage').addEventListener('input',updateFixButtonState);
        document.getElementById('sourceCode').addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();runConversion(false);}});
        
        function toggleErrorPanel(){
            const p=document.getElementById('errorPanel');
            const i=document.getElementById('chevronIcon');
            const t=document.getElementById('fixTimerDisplay');
            if(p.classList.contains('hidden')){
                p.classList.remove('hidden','flex');
                p.classList.add('flex');
                i.classList.add('rotate-180');
            }else{
                p.classList.add('hidden');
                p.classList.remove('flex');
                i.classList.remove('rotate-180');
                t.classList.add('hidden');
            }
        }
        function toggleModal(id){const e=document.getElementById(id);const c=e.firstElementChild;if(e.classList.contains('hidden')){e.classList.remove('hidden','opacity-0');e.classList.add('flex');setTimeout(()=>c.classList.remove('scale-95'),10);}else{e.classList.add('opacity-0');c.classList.add('scale-95');setTimeout(()=>e.classList.add('hidden'),300);}}
        
        function copyOutput(){
            const txt = document.getElementById('outputCode').value;
            if(txt){
                navigator.clipboard.writeText(txt);
                showToast(i18n[currentLang].linkCopied.replace('Link','Code').replace('Lien','Code'));
            }
        }
        
        function clearAll(){
            if(confirm(i18n[currentLang].clearMsg)){
                document.getElementById('sourceCode').value='';
                document.getElementById('outputCode').value='';
                document.getElementById('outputDisplay').innerHTML='';
                document.getElementById('outputPlaceholder').style.display='block';
                document.getElementById('errorMessage').value='';
                updateFixButtonState();
                document.getElementById('fixTimerDisplay').classList.add('hidden');
            }
        }

        function handleFiles(files) {
            // ä¸¥æ ¼åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
            const f = files[0];
            if(!f) return;
            const currentContent = document.getElementById('sourceCode').value.trim();
            if(currentContent && !confirm(i18n[currentLang].overwriteMsg)) {
                document.getElementById('fileInput').value = null; 
                return;
            }
            const r = new FileReader();
            r.onload = ev => {
                document.getElementById('sourceCode').value = ev.target.result;
                // æ¸…ç©º input ç¡®ä¿ä¸‹æ¬¡ä¸Šä¼ åŒåæ–‡ä»¶è§¦å‘ change äº‹ä»¶
                document.getElementById('fileInput').value = null; 
            };
            r.readAsText(f);
        }
        document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));

        setDirection('spss2stata');
        changeLanguage('en');
        updateFixButtonState();
        setTimeout(() => { initAuth(); }, 100);
    </script>
</body>
</html>